{{/*
	GetFeaturedImage with WebP optimization for Cloudflare

	This overrides Ananke's default GetFeaturedImage to provide WebP optimization.
	Optimizes images for web delivery with WebP format and proper sizing.
*/}}

{{/* Declare variables */}}
{{ $linkToCover := "" }}
{{ $matches := "feature,cover" }}

{{/* Use the value from front matter if present */}}
{{ with .Params.featured_image }}
  {{/* First check if we have a Page Resource matching the exact value */}}
  {{ with $.Resources.GetMatch . }}
    {{/* We have a page resource - optimize it to WebP */}}
    {{ if eq .MediaType.SubType "jpeg" "jpg" "png" "gif" }}
      {{/* Convert to WebP and resize for better performance */}}
      {{ $webp := .Resize "1200x webp q85" }}
      {{ $linkToCover = $webp.RelPermalink }}
    {{ else }}
      {{/* Use original if already WebP or other format */}}
      {{ $linkToCover = .RelPermalink }}
    {{ end }}
  {{ else }}
    {{/* Fallback to static directory (original behavior) */}}
    {{ $linkToCover = strings.Trim . "/" | urls.AbsURL }}
  {{ end }}

{{/* Find the first image with 'cover' in the name in this page bundle */}}
{{ else }}
  {{ with .Resources.ByType "image" }}
    {{ with .GetMatch (fmt.Printf "**{%s}*" $matches) }}
      {{/* Optimize cover image to WebP */}}
      {{ if eq .MediaType.SubType "jpeg" "jpg" "png" "gif" }}
        {{ $webp := .Resize "1200x webp q85" }}
        {{ $linkToCover = $webp.RelPermalink }}
      {{ else }}
        {{ $linkToCover = .RelPermalink }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Return the optimized image URL */}}
{{ return $linkToCover }}